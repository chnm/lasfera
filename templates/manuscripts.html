{% extends "base.html" %}
{% load static %}
{% load stanza_tags %}

{% block title %}Manuscript Traditions - La Sfera{% endblock title %}

{% block extra_css %}
<style>
    .annotated-text {
        background-color: #A8DCD9;
        cursor: help;
        position: relative;
        color: #1A1A1A;
        border-radius: 4px;
    }

    /* Annotation popup styles from annotations.js */
    .annotation-popup {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        padding: 12px;
        z-index: 1000;
        max-width: 300px;
        font-size: 0.9em;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }

    .annotation-popup.active {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="mx-auto">
    <section class="w-full p-4 my-10">
        <!-- Title -->
        <div>
            <h3 class="text-4xl pb-8 font-bold" id="top">
                Manuscript Traditions of Gregorio Dati's <em>La sfera</em>
            </h3>
        </div>

        <!-- Filter Panel -->
        <div x-data="{ isOpen: true }" class="mb-8">
            <button
                @click="isOpen = !isOpen"
                class="w-full flex items-center justify-between p-4 bg-gray-100 hover:bg-gray-200 rounded-t-lg border border-gray-300"
            >
                <span class="font-semibold">Manuscript Options</span>
                <svg
                    class="w-5 h-5 transition-transform duration-200"
                    :class="{'rotate-180': !isOpen}"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                >
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>

            <div
                x-show="isOpen"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform -translate-y-2"
                class="border border-t-0 border-gray-300 rounded-b-lg p-4 bg-white"
            >
                <div class="grid grid-cols-3 gap-4 p-4">
                    <!-- Manuscript Select -->
                    <div class="w-full">
                        <label for="manuscript-select" class="block text-gray-700 text-sm font-bold mb-2">
                            Select Manuscript:
                        </label>
                        <select 
                            id="manuscript-select" 
                            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                            {% for manuscript in manuscripts %}
                                <option value="{{ manuscript.siglum }}"
                                        {% if forloop.first %}selected{% endif %}>
                                    {{ manuscript.siglum }} &middot; {{ manuscript.shelfmark }} | {{ manuscript.library }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="w-full">
                      {# more if needed #} 
                    </div>

                    <div class="w-full">
                      {# more if needed #} 
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content wrapper -->
        <div class="flex w-full gap-8">
            <!-- Manuscript Text Content -->
            <div class="w-2/3">
    <div class="space-y-4">
            {% for book_number, stanza_pairs in stanza_pairs.items %}
  <div>
    <!-- Book headers -->
    <div class="gap-8 mb-4">
      <div>
        <h2 id="libre-{{book_number}}" class="text-xl font-serif font-bold mb-4">Libro/Book {{ book_number }}</h2>
      </div>
    </div>

    <!-- Stanza pairs -->
    {% for stanza_pair in stanza_pairs %}
      {% if stanza_pair.new_folio %}
      <div class="relative flex items-center my-6 folio-divider" 
           data-folio-number="{{ stanza_pair.folios.0 }}">
        <div class="font-medium text-gray-500 pr-4">
          Folio {{ stanza_pair.folios.0 }}
        </div>
        <div class="flex-grow border-t border-gray-300"></div>
      </div>
      {% endif %}

      <div class="gap-8 mb-8">
        <!-- Original stanza -->
        <div class="w-full">
          {% for stanza in stanza_pair.original %}
            <div class="relative">
              <div class="flex items-start">
                <span class="line-code mr-2">
                  <a class="no-underline" href="#{{stanza.stanza_line_code_starts}}"
                     id="{{stanza.stanza_line_code_starts}}"
                     title="Anchor link to line code {{ stanza.stanza_line_code_starts}}">
                    <span class="font-serif text-red-700 text-sm">
                      {{ stanza.stanza_line_code_starts }}
                    </span>
                  </a>
                </span>
                <span class="flex-1 pl-4">
                  {{ stanza.unescaped_stanza_text|safe }}
                </span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    <!-- Book separator -->
    <div class="flex items-center my-16 py-4">
      <div class="flex-grow border-t border-slate-300"></div>
      <span class="mx-4 text-slate-300 text-4xl">‚ù¶</span>
      <div class="flex-grow border-t border-slate-300"></div>
    </div>
  </div>
{% endfor %}
    </div>
</div>

            <!-- Annotation and Variant Sidebar -->
            <div class="w-1/3">
                <div class="sticky top-0">
                    <h3 class="text-xl font-bold mb-4">Manuscript Variations</h3>
                    
                    <!-- Variation List -->
                    <div id="variation-list" class="space-y-4">
                        {% comment %}
                        This section would dynamically populate with manuscript variations
                        {% endcomment %}
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-2">Textual Variation Example</h4>
                            <p class="text-sm text-gray-600">
                                Select text in the manuscript to see or add variations.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock content %}

{% block scripts %}
    <script src="{% static 'js/annotations.js' %}"></script>
    <script src="{% static 'js/stanza.js' %}"></script>
    <script>
        // Manuscript-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const manuscriptSelect = document.getElementById('manuscript-select');
            const traditionFilter = document.getElementById('tradition-filter');
            const dateRangeFilter = document.getElementById('date-range');

            // Add event listeners for filtering
            manuscriptSelect.addEventListener('change', function() {
                window.location.href = `/manuscripts/${this.value}/`;
            });

            // Placeholder for more advanced filtering logic
            function applyFilters() {
                const selectedTradition = traditionFilter.value;
                const selectedDateRange = dateRangeFilter.value;

                // Future implementation: filter manuscripts based on selections
                console.log('Filtering by:', selectedTradition, selectedDateRange);
            }

            traditionFilter.addEventListener('change', applyFilters);
            dateRangeFilter.addEventListener('change', applyFilters);
        });
    </script>
{% endblock scripts %}

